<tool id="rcx_upsetplot" name="recetox-upsetplot" version="@TOOL_VERSION@+galaxy0" profile="23.0">
    <description>Upset plot visualization tool using UpSetR</description>
    <macros>
        <import>macros.xml</import>
        <import>help.xml</import>
    </macros>

    <requirements>
        <requirement type="package" version="1.4.0">r-upsetr</requirement>
        <requirement type="package" version="19.0.0">r-arrow</requirement>
    </requirements>
    <required_files>
        <include path="utils.r" />
    </required_files>
    <expand macro="creator" />

    <command detect_errors="exit_code"><![CDATA[
        Rscript -e 'source("${__tool_directory__}/utils.r")' -e 'source("${run_script}")'
        #if $export_R_script
        && cat ${run_script} >> $script
        #end if
    ]]></command>

    <configfiles>
        <configfile name="run_script"><![CDATA[
        file_name <- "$input_data"
        file_extension <- "$input_data.ext"
        data_input <- load_data(file_name, file_extension)
        
        data_input[data_input != 0] <- 1

        png("upsetplot.png", width = 12, height = 12, units = 'in', res = 600)
        p <- UpSetR::upset(data_input, 
                           order.by = "$sort_by", 
                           #if $nintersects == 0
                           nintersects = NA,
                           #else 
                           nintersects = $nintersects,
                           #end if
                           #if $group_by_sets
                           group.by = "sets",
                           #end if
                           #if "$empty_intersections"
                           empty.intersections = "on"
                           #end if
                         )
        print(p)
        dev.off()
        ]]></configfile>
    </configfiles>

    <inputs>
        <expand macro="upsetplot_param"/>
    </inputs>

    <outputs>
        <data name="upsetplot" format="png" label="Upset plot on ${on_string}" from_work_dir="upsetplot.png"/>        
        <data name="script" format="txt" label="R script">
            <filter>export_R_script</filter>
        </data>
    </outputs>

    <tests>
        <test expect_num_outputs="1">
            <param name="input_data" value="upsetplot_test_data.txt"/>
            <param name="sort_by" value="freq"/>
            <output name="upsetplot" ftype="png">
                <assert_contents>
                    <has_size size="1164615" delta="200"/>
                </assert_contents>
            </output>          
        </test>
    </tests>

    <help><![CDATA[
        @UPSETPLOT_HELP@
    ]]></help>

    <expand macro="citations_upset" />
</tool>