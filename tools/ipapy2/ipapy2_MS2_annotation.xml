<tool id="ipapy2_MS2_annotation" name="IPA MS2 annotation" version="@TOOL_VERSION@+galaxy0" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ipapy2</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
         python3  '${__tool_directory__}/ipapy2_MS2_annotation.py'
            --mapped_isotope_patterns '${mapped_isotope_patterns}'
            --MS2_fragmentation_data '${MS2_fragmentation_data}'
            --all_adducts '${all_adducts}'
            --MS2_DB '${MS2_DB}'
            --ppm ${ppm}
            --me ${me}
            --ratiosd ${ratiosd}
            #if $ppmunk
            --ppmunk ${ppmunk}
            #else
                --ppmunk ${ppm}
            #end if
            --ratiounk ${ratiounk}
            #if $ppmthr
                --ppmthr ${ppmthr}
            #else
                --ppmthr 0
            #end if
            --pRTNone ${pRTNone}
            --pRTout ${pRTout}
            --mzdCS ${mzdCS}
            --ppmCS ${ppmCS}
            --CSunk ${CSunk}
            --evfilt ${evfilt}
    ]]></command>

    <inputs>
        <param label="Mapped isotope patterns" name="mapped_isotope_patterns" type="data" format="csv" help="A csv file containing the MS1 data. Ideally obtained from map_isotope_patterns" />
        <param label="MS2 fragmentation data" name="MS2_fragmentation_data" type="data" format="csv" help="A csv file containing the MS2 data." />
        <param label="all possible adducts table" name="all_adducts" type="data" format="csv" help="A csv file containing the information on all the possible adducts given the database." />
        <param label="MS2 Database" name="MS2_DB" type="data" format="csv" help="A csv file containing the database containing the MS2 information." />
        <param label="ppm" name="ppm" type="float" help="accuracy of the MS instrument used."/>
        <section name="unknown" title="unknown settings">
            <param name="ppmunk" type="float" optional="true">
                <label>ppm for unknown</label>
                <help>ppm associated to the 'unknown' annotation. If not provided equal to ppm.</help>
            </param>
            <param name="ratiounk" type="float" value="0.5">
                <label>isotope ratio for unknown</label>
                <help>isotope ratio associated to the 'unknown' annotation. Default 0.5.</help>
            </param>
            <param name="CSunk" type="float" value="0.7">
                <label>cosine similarity for unknown</label>
                <help>cosine similarity score associated with the 'unknown' annotation. Default 0.7.</help>
            </param>
        </section>

        <section name="optional_settings" title="optional settings">
            <param name="me" type="float" value="5.48579909065e-04" label="mass of the electron">
                <help>accurate mass of the electron. Default 5.48579909065e-04</help>
            </param>
            <param name="ratiosd" type="float" value="0.9" label="intensity ratio">
                <help>acceptable ratio between predicted intensity and observed intensity of isotopes</help>
            </param>
            <param name="ppmthr" type="float" optional="true" label="ppm threshold">
                <help>maximum ppm possible for the annotations. if not provided equal to 2*ppm.</help>
            </param>
            <param name="pRTNone" type="float" value="0.8" label="no RT factor">
                <help>multiplicative factor for the RT if no RTrange present in the database.</help>
            </param>
            <param name="pRTout" type="float" value="0.4" label="outside RT factor">
                <help>multiplicative factor for the RT if measured RT is outside the RTrange present in the database.</help>
            </param>
            <param name="mzdCS" type="float" value="0" label="MS2 mz threshold">
                <help>maximum mz difference allowed when computing cosine similarity scores. 
                If one wants to use this parameter instead of ppmCS, this must be set to 0. Default 0.</help>
            </param>
            <param name="ppmCS" type="float" value="10" label="maximum ppm for cosine similarity scores">
                <help>maximum ppm allowed when computing cosine similarity scores. 
                If one wants to use this parameter instead of mzdCS, this must be set to 0. Default 10.</help>
            </param>
            <param name="evfilt" type="select" label="same collision energy">
                <help>If true, only spectrum acquired with the same collision energy are considered. Default value False.</help>
                <option value="False">False</option>
                <option value="True">True</option>
            </param>
        </section>
    </inputs>

    <outputs>
        <data label="${tool.name} on ${on_string}" name="output" format="csv"/>
    </outputs>

    <tests>
        <test>
            <param name="MS1_table" value="isotope_patterns.csv"/>
            <param name="MS2_table" value="MS2_table.csv"/>
            <param name="all_adducts" value="all_adducts.csv"/>
            <param name="DBMS2_table" value="DB_MS2.csv"/>
            <param name="ppm" value="3"/>
            <output name="output" file="annotations.csv"/>
        </test>
    </tests>

    <help><![CDATA[
    ::
        Annotation of the dataset base on the MS1 and MS2 information. Prior
        probabilities are based on mass only, while post probabilities are based
        on mass, RT, previous knowledge and isotope patterns.
    ]]></help>

    <expand macro="citations"/>
</tool>