<tool id="ipapy2_MS2_annotation" name="IPA MS2 annotation" version="@TOOL_VERSION@+galaxy0" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ipapy2</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        python3 '${ipapy2_MS2_annotation_cli}'
    ]]></command>

<configfiles>
<configfile name="ipapy2_MS2_annotation_cli">
@init_import@
import os

df = pd.read_csv('${MS1_table}', keep_default_na=False)
df = df.replace('', None)
dfMS2 = pd.read_csv('${MS2_table}', keep_default_na=False)
dfMS2 = dfMS2.replace('', None)
allAdds = pd.read_csv('${all_adducts}', keep_default_na=False)
allAdds = allAdds.replace('', None)
DBMS2 = pd.read_csv('${DBMS2_table}', keep_default_na=False)
DBMS2 = DBMS2.replace('', None)
ppmunk = os.getenv('ppmunk', $ppm)
ppmthr = os.getenv('ppmthr', 2*$ppm)
annotations = ipa.MSMSannotation(df, dfMS2, allAdds, DBMS2, ppm=$ppm, ratiosd=$ratiosd, ppmunk=ppmunk, ratiounk=$ratiounk, ppmthr=ppmthr, pRTNone=$pRTNone, pRTout=$pRTout, mzdCS=$mzdCS, ppmCS=$ppmCS, CSunk=$CSunk, evfilt=$evfilt, ncores=int(os.environ.get('GALAXY_SLOTS')))
@annotation_flatten@
annotations_flat.to_csv('${output}', index=False)
</configfile>
</configfiles>

    <inputs>
        <param label="MS1 table" name="MS1_table" type="data" format="csv" help="pandas dataframe containing the MS1 data." />
        <param label="MS2 table" name="MS2_table" type="data" format="csv" help="pandas dataframe containing the MS2 data." />
        <param label="all possible adducts table" name="all_adducts" type="data" format="csv" help="pandas dataframe containing the information on all the possible adducts given the database." />
        <param label="DBMS2 table" name="DBMS2_table" type="data" format="csv" help="pandas dataframe containing the database containing the MS2 information." />
        <param label="ppm" name="ppm" type="float" help="accuracy of the MS instrument used."/>
        <section name="unknown" title="unknown settings">
            <param name="ppmunk" type="float" optional="true">
                <label>ppm for unknown</label>
                <help>ppm associated to the 'unknown' annotation. If not provided equal to ppm.</help>
            </param>
            <param name="ratiounk" type="float" value="0.5">
                <label>isotope ratio for unknown</label>
                <help>isotope ratio associated to the 'unknown' annotation. Default 0.5.</help>
            </param>
            <param name="CSunk" type="float" value="0.7">
                <label>cosine similarity for unknown</label>
                <help>cosine similarity score associated with the 'unknown' annotation. Default 0.7.</help>
            </param>
        </section>

        <section name="optional_settings" title="optional settings">
            <param name="ratiosd" type="float" value="0.9" label="intensity ratio">
                <help>acceptable ratio between predicted intensity and observed intensity of isotopes</help>
            </param>
            <param name="ppmthr" type="float" optional="true" label="ppm threshold">
                <help>maximum ppm possible for the annotations. if not provided equal to 2*ppm.</help>
            </param>
            <param name="pRTNone" type="float" value="0.8" label="no RT factor">
                <help>multiplicative factor for the RT if no RTrange present in the database.</help>
            </param>
            <param name="pRTout" type="float" value="0.4" label="outside RT factor">
                <help>multiplicative factor for the RT if measured RT is outside the RTrange present in the database.</help>
            </param>
            <param name="mzdCS" type="float" value="0" label="MS2 mz threshold">
                <help>maximum mz difference allowed when computing cosine similarity scores. 
                If one wants to use this parameter instead of ppmCS, this must be set to 0. Default 0.</help>
            </param>
            <param name="ppmCS" type="float" value="10" label="maximum ppm for cosine similarity scores">
                <help>maximum ppm allowed when computing cosine similarity scores. 
                If one wants to use this parameter instead of mzdCS, this must be set to 0. Default 10.</help>
            </param>
            <param name="evfilt" type="select" label="same collision energy">
                <help>If true, only spectrum acquired with the same collision energy are considered. Default value False.</help>
                <option value="False">False</option>
                <option value="True">True</option>
            </param>
        </section>
    </inputs>

    <outputs>
        <data label="${tool.name} on ${on_string}" name="output" format="csv" help="a dictionary containing all the possible annotations for the measured features."/>
    </outputs>

    <tests>
        <test>
            <param name="MS1_table" value="MS1_data.csv"/>
            <param name="MS2_table" value="MS2_data.csv"/>
            <param name="all_adducts" value="all_adducts.csv"/>
            <param name="DBMS2_table" value="MS2_DB.csv"/>
            <param name="ppm" value="3"/>
            <output name="output" file="annotations.csv"/>
        </test>
    </tests>

    <help><![CDATA[
    ::
        Annotation of the dataset base on the MS1 and MS2 information. Prior
        probabilities are based on mass only, while post probabilities are based
        on mass, RT, previous knowledge and isotope patterns.
    ]]></help>

    <expand macro="citations"/>
</tool>