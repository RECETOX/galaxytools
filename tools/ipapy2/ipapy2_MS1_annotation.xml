<tool id="ipapy2_MS1_annotation" name="IPA MS1 annotation" version="@TOOL_VERSION@+galaxy0" profile="21.09">
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ipapy2</requirement>
        <expand macro="extra_requirements"/>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        #set $computed_ppmthr = float($ppm) * 2
        python3  '${__tool_directory__}/ipapy2_MS1_annotation.py'
        --input_dataset_database '${mapped_isotope_patterns}' '${mapped_isotope_patterns.ext}'
        --input_dataset_adducts '${all_adducts}' '${all_adducts.ext}'
        --ppm ${ppm}
        --ratiosd ${ratiosd}
        #if $ppmunk
            --ppmunk ${ppmunk}
        #else
            --ppmunk ${ppm}
        #end if
        --ratiounk ${ratiounk}
        #if $ppmthr
            --ppmthr ${ppmthr}
        #else
            --ppmthr ${computed_ppmthr}
        #end if
        --pRTNone ${pRTNone}
        --pRTout ${pRTout}
        --output_dataset '${MS1_annotations}' '${MS1_annotations.ext}'
        --ncores \${GALAXY_SLOTS:-1}
    ]]></command>

    <inputs>
        <param label="Mapped isotope patterns" name="mapped_isotope_patterns" type="data" format="csv,tsv,tabular,parquet" help="A dataset containing the MS1 data. Ideally obtained from map_isotope_patterns" />
        <param label="all possible adducts" name="all_adducts" type="data" format="csv,tsv,tabular,parquet" help="A dataset containing the information on all the possible adducts given the database. Ideally obtained from compute_all_adducts" />
        <expand macro="ppm"/>
        <section name="unknown" title="settings for the identification of unknowns">
            <expand macro="ms_unknown"/>
        </section>
        <section name="optional_settings" title="optional settings">
            <expand macro="ms_options"/>
        </section>
    </inputs>

    <outputs>
        <data label="${tool.name} on ${on_string}" name="MS1_annotations" format_source="mapped_isotope_patterns"/>
    </outputs>

    <tests>
        <test>
            <param name="mapped_isotope_patterns" value="mapped_isotope_patterns.csv"/>
            <param name="all_adducts" value="all_adducts.csv"/>
            <param name="ppm" value="3"/>
            <output name="MS1_annotations" file="MS1_annotations.csv" lines_diff="20"/>
        </test>
    </tests>

    <help><![CDATA[
    ::
        Annotation of the dataset based on the MS1 information. Prior probabilities
        are based on mass only, while post probabilities are based on mass, RT,
        previous knowledge and isotope patterns.
    ]]></help>

    <expand macro="citations"/>
</tool>