<tool id="ipapy2_MS1_annotation" name="IPA MS1 annotation" version="@TOOL_VERSION@+galaxy0" profile="21.09">
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ipapy2</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        python3 '${ipapy2_MS1_annotation_cli}'
    ]]></command>

<configfiles>
<configfile name="ipapy2_MS1_annotation_cli">
@init_import@
import os

df = pd.read_csv('${MS1_table}', keep_default_na=False)
df = df.replace('', None)
allAdds = pd.read_csv('${all_adducts}', keep_default_na=False)
allAdds = allAdds.replace('', None)
ppmunk = os.getenv('ppmunk', $ppm)
ppmthr = os.getenv('ppmthr', 2*$ppm)
annotations = ipa.MS1annotation(df, allAdds, ppm=$ppm, ratiosd=$ratiosd, ppmunk=ppmunk, ratiounk=$ratiounk, ppmthr=ppmthr, pRTNone=$pRTNone, pRTout=$pRTout, ncores=int(os.environ.get('GALAXY_SLOTS')))
@annotation_flatten@
annotations_flat.to_csv('${output}', index=False)
</configfile>
</configfiles>

    <inputs>
        <param label="MS1 table" name="MS1_table" type="data" format="csv" help="pandas dataframe containing the MS1 data." />
        <param label="all possible adducts table" name="all_adducts" type="data" format="csv" help="pandas dataframe containing the information on all the possible adducts given the database." />
        <param label="ppm" name="ppm" type="float" help="accuracy of the MS instrument used."/>
        <section name="unknown" title="unknown settings">
            <param name="ppmunk" type="float" optional="true">
                <label>ppm for unknown</label>
                <help>ppm associated to the 'unknown' annotation. If not provided equal to ppm.</help>
            </param>
            <param name="ratiounk" type="float" optional="true" value="0.5">
                <label>isotope ratio for unknown</label>
                <help>isotope ratio associated to the 'unknown' annotation.</help>
            </param>
        </section>
        <section name="optional_settings" title="optional settings">
            <param name="ratiosd" type="float" value="0.9" optional="true">
                <label>intensity ratio</label>
                <help>acceptable ratio between predicted intensity and observed intensity of isotopes</help>
            </param>
            <param name="ppmthr" type="float" optional="true">
                <label>ppm threshold</label>
                <help>maximum ppm possible for the annotations. if not provided equal to 2*ppm.</help>
            </param>
            <param name="pRTNone" type="float" optional="true" value="0.8">
                <label>no RT factor</label>
                <help>multiplicative factor for the RT if no RTrange present in the database.</help>
            </param>
            <param name="pRTout" type="float" optional="true" value="0.4">
                <label>outside RT factor</label>
                <help>multiplicative factor for the RT if measured RT is outside the RTrange present in the database.</help>
            </param>
        </section>
    </inputs>

    <outputs>
        <data label="${tool.name} on ${on_string}" name="output" format="csv"/>
    </outputs>

    <tests>
        <test>
            <param name="MS1_table" value="MS1_data.csv"/>
            <param name="all_adducts" value="all_adducts.csv"/>
            <param name="ppm" value="3"/>
            <output name="output" file="annotations.csv"/>
        </test>
    </tests>

    <help><![CDATA[
    ::
        Annotation of the dataset base on the MS1 information. Prior probabilities
        are based on mass only, while post probabilities are based on mass, RT,
        previous knowledge and isotope patterns.
    ]]></help>

    <expand macro="citations"/>
</tool>