<tool id="ipapy2_gibbs_sampler" name="IPA gibbs sampler" version="@TOOL_VERSION@+galaxy0" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ipapy2</requirement>
        <expand macro="extra_requirements"/>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        python3 '${__tool_directory__}/ipapy2_gibbs_sampler.py'
        --input_dataset_mapped_isotope_patterns '${mapped_isotope_patterns}' '${mapped_isotope_patterns.ext}'
        --input_dataset_annotations '${annotations}' '${annotations.ext}'
        --integrating_mode '${integrating_mode.integrating_mode}'
        #if $integrating_mode.integrating_mode == "adducts"
            --delta_add '${integrating_mode.delta_add}'
        #elif $integrating_mode.integrating_mode == "biochemical"
            --input_dataset_bio '${integrating_mode.Bio}' '${integrating_mode.Bio.ext}'
            --delta_bio '${integrating_mode.delta_bio}'
        #else
            --delta_add '${integrating_mode.delta_add}'
            --input_dataset_bio '${integrating_mode.Bio}' '${integrating_mode.Bio.ext}'
            --delta_bio '${integrating_mode.delta_bio}'
        #end if
        --noits '${noits}'
        --burn '${burn}'
        --all_out '${all_out}'
        #if $zs:
            --zs '${zs}' '${zs.ext}'
        #else:
            --zs '' ''
        #end if
        #if $zs_out:
            --zs_out '${zs_out}' '${zs_out.ext}'
        #else:
            --zs_out '' ''
        #end if
        --output_dataset '${annotations_out}' '${annotations_out.ext}'

    ]]></command>

    <inputs>
        <expand macro="gibbs"/>
        
        <conditional name="integrating_mode">
            <param name="integrating_mode" type="select" label="integrating mode" help="select the integrating mode">
                <option value="adducts">adducts</option>
                <option value="biochemical">biochemical</option>
                <option value="both">adducts and biochemical</option>
            </param>
            <when value="adducts">
                <param name="delta_add" type="float" value="1" min="0" label="adducts weight" 
                        help="parameter used when computing the conditional priors. The parameter must be positive. 
                        The smaller the parameter the more weight the adducts connections have on the posterior probabilities. Default 1." />
            </when>
            <when value="biochemical">
                <param name="Bio" type="data" format="csv,tsv,tabular,parquet" label="biochemical connections" 
                        help="dataframe (2 columns), reporting all the possible connections between compounds. It uses the unique ids from the database. 
                        It could be the output of Compute_Bio() or Compute_Bio_Parallel()." />
                <param name="delta_bio" type="float" value="1" min="0" label="biochemical weight" 
                        help="parameter used when computing the conditional priors. The parameter must be positive. 
                        The smaller the parameter the more weight the biochemical connections have on the posterior probabilities. Default 1." />            
            </when>
            <when value="both">
                <param name="delta_add" type="float" value="1" min="0" label="adducts weight" 
                        help="parameter used when computing the conditional priors. The parameter must be positive. 
                        The smaller the parameter the more weight the adducts connections have on the posterior probabilities. Default 1." />
                <param name="Bio" type="data" format="csv,tsv,tabular,parquet" label="biochemical connections" 
                        help="dataframe (2 columns), reporting all the possible connections between compounds. It uses the unique ids from the database. 
                        It could be the output of Compute_Bio() or Compute_Bio_Parallel()." />
                <param name="delta_bio" type="float" value="1" min="0" label="biochemical weight" 
                        help="parameter used when computing the conditional priors. The parameter must be positive. 
                        The smaller the parameter the more weight the biochemical connections have on the posterior probabilities. Default 1." /> 
            </when>
        </conditional>
    </inputs>

    <outputs>
        <data label="${tool.name} annotations on ${on_string}" name="annotations_out" format_source="mapped_isotope_patterns"/>
        <data label="${tool.name} zs on ${on_string}" name="zs_out" format="txt">
            <filter>options['all_out']</filter>
        </data>
    </outputs>

    <tests>
        <test  expect_num_outputs="2">
            <param name="mapped_isotope_patterns" value="mapped_isotope_patterns.parquet"/>
            <param name="annotations" value="clean_annotations.csv"/>
            <!-- Not the best way to test, but the results are stochastic hence difficult to test-->
            <output name="annotations_out">
                <assert_contents>
                    <has_size value="9185" delta="100" />
                </assert_contents>
            </output>
        </test>
    </tests>

    <help><![CDATA[
        ::
            Gibbs sampler for the IPA model.
    ]]></help>

    <expand macro="citations"/>
</tool>