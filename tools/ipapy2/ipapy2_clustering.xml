<tool id="ipapy2_clustering" name="IPA clustering" version="@TOOL_VERSION@+galaxy0" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ipapy2</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        python3 '${ipapy2_clustering_cli}'
    ]]></command>

<configfiles>
<configfile name="ipapy2_clustering_cli">
@init_import@

intensity_table = pd.read_csv('${intensity_table}')
result = ipa.clusterFeatures(intensity_table, Cthr=$clustering.Cthr, RTwin=$clustering.RTwin, Intmode='${clustering.Intmode}')
result.to_csv('${output}', index=False)
</configfile>
</configfiles>

    <inputs>
        <param label="Intensity table" name="intensity_table" type="data" format="csv" help="a dataframe containing the measured intensities across several samples." />
        <section name="clustering" title="clustering settings">
            <param name="Cthr" type="float" value="0.8">
                <label>correlation threshold</label>
                <help>Minimum correlation allowed in each cluster. Default value 0.8.</help>
            </param>
            <param name="RTwin" type="float" value="1">
                <label>RT threshold</label>
                <help>Maximum difference in RT time between features in the same cluster. Default value 1.</help>
            </param>
            <param name="Intmode" type="text" value="max">
                <label>intensity mode</label>
                <help>intensity mode. Default 'max' or 'ave'.</help>
            </param>
        </section>
    </inputs>

    <outputs>
        <data label="${tool.name} on ${on_string}" name="output" format="csv"/>
    </outputs>

    <tests>
        <test>
            <param name="intensity_table" value="unclustered.csv"/>
            <output name="output" file="clustered features.csv"/>
        </test>
    </tests>

    <help><![CDATA[
    Before using the ipaPy2 package, the processed data coming from an untargeted metabolomics experiment must be properly prepared.
    The data must be organized in a pandas dataframe containing the following columns:

    - **ids**: an unique numeric id for each mass spectrometry feature 
    - **rel.ids**: relation ids. Features must be clustered based on correlation/peak shape/retention time. Features in the same cluster are likely to come from the same metabolite.
    - **mzs**: mass-to-charge ratios, usually the average across different samples.
    - **RTs**: retention times in seconds, usually the average across different samples.
    - **Int**: representative (e.g., maximum or average) intensity detected for each feature across samples (either peak area or peak intensity)

    The clustering of the features is a necessary and must be performed before running the IPA method.
    For this step, the use of widely used data processing software such as mzMatch and CAMERA is recommended.
    Nevertheless, the ipaPy2 library provides a function (clusterFeatures()) able to perform such step,
    starting from a dataframe containing the measured intensities across several samples (at least 3 samples, the more samples the better).
    Such dataframe should be organized as follows:

    +----+------+-----+-------------+-------------+-------------+
    | id | mz   | rt  | intensity_1 | intensity_2 | intensity_3 |
    +====+======+=====+=============+=============+=============+
    | 1  | 100  | 10  | 500         | 600         | 700         |
    +----+------+-----+-------------+-------------+-------------+
    | 2  | 200  | 20  | 800         | 900         | 1000        |
    +----+------+-----+-------------+-------------+-------------+
    | 3  | 300  | 30  | 1100        | 1200        | 1300        |
    +----+------+-----+-------------+-------------+-------------+
    ]]></help>
    
    <expand macro="citations"/>
</tool>