<tool id="ipapy2_compute_bio" name="IPA compute bio" version="@TOOL_VERSION@+galaxy0" profile="21.05">
    <macros>
        <import>macros.xml</import>
    </macros>
    
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">ipapy2</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        python3 '${__tool_directory__}/ipapy2_compute_bio.py'
        --MS1_DB '${MS1_DB}'
        --annotations '${annotations}'
        --biochemical_mode '${biochemical_mode.biochemical_mode}'
        #if $biochemical_mode.biochemical_mode == "connections"
            --connection_list '${biochemical_mode.connection_list}'
        #end if
        --compute_bio_output "${compute_bio_output}"
    ]]></command>

    <inputs>
        <param label="MS1 DB table" name="MS1_DB" type="data" format="csv,tsv,tabular,parquet" help="pandas dataframe containing the MS1 database."/>
        <param label="annotations" name="annotations" type="data" format="csv,tsv,tabular,parquet" optional="true" help="pandas dataframe containing all the possible annotations for the measured features."/>
        <conditional name="biochemical_mode">
            <param name="biochemical_mode" type="select" label="biochemical mode"
                    help="connections are computed based on the reactions or connections.">
                    <option value="reactions" selected="true">reactions</option>
                    <option value="connections">connections</option>
            </param>
            <when value="reactions">
            </when>
            <when value="connections">
                <param name="connection_list" type="text" optional="true" label="connections list provided" 
                        help="list of possible connections between compounds defined as formulas. Only necessary if mode='connections'."/>           
            </when>
        </conditional>
    </inputs>

    <outputs>
        <data label="${tool.name} on ${on_string}" name="compute_bio_output" format="csv,tsv,tabular,parquet"/>
    </outputs>

    <tests>
        <test>
            <param name="MS1_DB" value="compute_bio_db.csv"/>
            <param name="annotations" value="clean_annotations.csv"/>
            <param name="biochemical_mode" value="reactions"/>
            <!-- Not the best way to test, but the results are stochastic hence difficult to test-->
            <output name="compute_bio_output">
                <assert_contents>
                    <has_text text="C00079" />
                    <has_n_columns n="2"  sep=","/>
                    <has_n_lines n="2" delta="3" />
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
    ::
        The IPA method can update the probabilities associated to each possible annotations by considering all possible biochemical connections.
        Before doing so, it is necessary to provide a pandas dataframe reporting which compounds can be considered biochemically related. 
        The function Compute_Bio() can be used to compute such a dataframe. 
    ]]></help>

    <expand macro="citations"/>
</tool>