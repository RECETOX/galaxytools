<tool id="msquality" name="MsQuality" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.09">
    <description>Calculate quality metrics for mass spectrometry data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="creator"/>
    <expand macro="requirements"/>
    
    <command detect_errors="exit_code"><![CDATA[
        Rscript '${__tool_directory__}/msquality.R' 
            --inputs '${inputs_file}'
            --ms2_metrics '${metrics.ms2_metrics}'
    ]]></command>
    
    <configfiles>
        <configfile name="inputs_file"><![CDATA[
#if $input_files.input_type == "single"
${input_files.input_file}
#else
#for $file in $input_files.input_collection
${file}
#end for
#end if
        ]]></configfile>
    </configfiles>
    
    <inputs>
        <conditional name="input_files">
            <param name="input_type" type="select" label="Input type">
                <option value="single">Single file</option>
                <option value="collection">Collection of files</option>
            </param>
            <when value="single">
                <param name="input_file" type="data" format="mzml" label="Input mzML file"
                    help="Mass spectrometry data file in mzML format"/>
            </when>
            <when value="collection">
                <param name="input_collection" type="data_collection" collection_type="list" format="mzml"
                    label="Input mzML collection"
                    help="Collection of mass spectrometry data files in mzML format"/>
            </when>
        </conditional>
        
        <section name="metrics" title="Quality Metrics" expanded="true">
            <param name="default_metrics" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true"
                label="Calculate default metrics"
                help="Calculate all metrics that don't require additional parameters"/>
            
            <param name="ms2_metrics" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false"
                label="Calculate MS2-specific metrics"
                help="Calculate metrics specific to MS2 (tandem MS) data"/>
        </section>
    </inputs>
    
    <outputs>
        <data name="output_table" format="tabular" from_work_dir="output_table.tsv" label="${tool.name} on ${on_string}: Quality Metrics"/>
    </outputs>
    
    <tests>
        <test>
            <param name="input_type" value="single"/>
            <param name="input_file" value="test_sample.mzML"/>
            <param name="default_metrics" value="TRUE"/>
            <output name="output_table">
                <assert_contents>
                    <has_n_columns n="2"/>
                    <has_line_matching expression="^Metric\t.*"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
**What it does**

This tool calculates quality metrics for mass spectrometry data using the MsQuality package from Bioconductor.
The tool can process single mzML files or collections of files and outputs a table with quality metrics.

**Input**

- **Input mzML file(s)**: Mass spectrometry data in mzML format. Can be a single file or a collection of files.

**Parameters**

- **Calculate default metrics**: When enabled, calculates all quality metrics that don't require additional parameters.
  These include metrics for chromatography, MS1 spectra, and general data quality.

- **Calculate MS2-specific metrics**: When enabled, includes metrics specific to MS2 (tandem MS) data.

**Output**

A tabular file containing quality metrics. The table has:
- Rows representing different quality metrics
- Columns representing samples (when using a collection) or a single sample column

**Available Metrics**

The default metrics include (but are not limited to):
- Chromatography metrics (retention time, peak widths, TIC)
- MS1 metrics (number of MS1 spectra, m/z range)
- Signal quality metrics (intensity distributions, signal-to-noise)
- Data completeness metrics

**References**

For more information about the MsQuality package and available metrics, see:
https://bioconductor.org/packages/release/bioc/html/MsQuality.html
    ]]></help>
    
    <expand macro="citations"/>
</tool>
