<tool id="msquality" name="MsQuality" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="21.09">
    <description>Calculate quality metrics for mass spectrometry data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="creator"/>
    <expand macro="requirements"/>
    
    <command detect_errors="exit_code"><![CDATA[
        Rscript '${__tool_directory__}/msquality.R' 
            --inputs '${inputs_file}'
            --default_metrics '${metrics.default_metrics}'
            --ms2_metrics '${metrics.ms2_metrics}'
    ]]></command>
    
    <configfiles>
        <configfile name="inputs_file"><![CDATA[
#if $input_files.input_type == "single"
${input_files.input_file}
#else
#for $file in $input_files.input_collection
${file}
#end for
#end if
        ]]></configfile>
    </configfiles>
    
    <inputs>
        <conditional name="input_files">
            <param name="input_type" type="select" label="Input type">
                <option value="single">Single file</option>
                <option value="collection">Collection of files</option>
            </param>
            <when value="single">
                <param name="input_file" type="data" format="mzml" label="Input mzML file"
                    help="Mass spectrometry data file in mzML format"/>
            </when>
            <when value="collection">
                <param name="input_collection" type="data_collection" collection_type="list" format="mzml"
                    label="Input mzML collection"
                    help="Collection of mass spectrometry data files in mzML format"/>
            </when>
        </conditional>
        
        <section name="metrics" title="Quality Metrics" expanded="true">
            <param name="default_metrics" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="true"
                label="Calculate default metrics"
                help="Calculate all metrics that don't require additional parameters"/>
            
            <param name="ms2_metrics" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false"
                label="Calculate MS2-specific metrics"
                help="Calculate metrics specific to MS2 (tandem MS) data"/>
        </section>
    </inputs>
    
    <outputs>
        <data name="output_table" format="tabular" from_work_dir="output_table.tsv" label="${tool.name} on ${on_string}: Quality Metrics"/>
    </outputs>
    
    <tests>
        <test expect_num_outputs="1">
            <param name="input_type" value="single"/>
            <param name="input_file" value="test_sample.mzML"/>
            <param name="default_metrics" value="TRUE"/>
            <param name="ms2_metrics" value="FALSE"/>
            <output name="output_table">
                <assert_contents>
                    <has_n_columns n="2"/>
                    <has_line_matching expression="^Metric\t.*"/>
                    <has_line_matching expression="^areaUnderTIC\t.*"/>
                    <has_line_matching expression="^numberSpectra\t.*"/>
                </assert_contents>
            </output>
        </test>
        <test expect_num_outputs="1">
            <param name="input_type" value="collection"/>
            <param name="input_collection">
                <collection type="list">
                    <element name="sample1" value="test_sample.mzML"/>
                    <element name="sample2" value="test_sample2.mzML"/>
                </collection>
            </param>
            <param name="default_metrics" value="TRUE"/>
            <param name="ms2_metrics" value="TRUE"/>
            <output name="output_table">
                <assert_contents>
                    <has_n_columns n="3"/>
                    <has_line_matching expression="^Metric\t.*"/>
                    <has_line_matching expression="^areaUnderTIC\t.*"/>
                    <has_line_matching expression="^numberMS2Spectra\t.*"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    
    <help><![CDATA[
**What it does**

This tool calculates quality metrics for mass spectrometry data using the MsQuality package from Bioconductor.
The MsQuality package provides functionality to calculate quality metrics for mass spectrometry-derived, 
spectral data at the per-sample level, following the mzQC framework defined by HUPO-PSI.

The tool can process single mzML files or collections of files and outputs a table with quality metrics
that can be used to:
- Assess data quality before downstream analysis
- Compare quality across multiple samples
- Identify potential issues in data acquisition
- Monitor instrument performance over time

**Input**

- **Input mzML file(s)**: Mass spectrometry data in mzML format. Can be a single file or a collection of files.
  When using a collection, all files will be processed and results will be combined into a single table.

**Parameters**

- **Calculate default metrics**: When enabled, calculates all quality metrics that don't require additional parameters.
  These include metrics for chromatography, MS1 spectra, and general data quality.

- **Calculate MS2-specific metrics**: When enabled, includes metrics specific to MS2 (tandem MS) data.

**Output**

A tabular file containing quality metrics. The table has:
- Rows representing different quality metrics
- Columns representing samples (when using a collection) or a single sample column

**Available Metrics**

The default metrics calculated by this tool include:

*Chromatography Quality:*
- **chromatographyDuration**: Total duration of the chromatography run
- **rtDuration**: Retention time duration
- **rtIqr**: Interquartile range of retention times
- **rtIwq**: Interquartile width of retention times
- **rtOverMsQuarters**: Distribution of retention times across MS acquisition

*Signal Quality:*
- **areaUnderTIC**: Total area under the Total Ion Chromatogram
- **areaUnderTicRtQuantiles**: Area under TIC for retention time quantiles
- **ticQuartiles**: Quartile values of the Total Ion Chromatogram
- **medianTicRtIwQuartiles**: Median TIC values for RT quartiles
- **msSignal10xChange**: Frequency of 10-fold signal changes

*MS1 Spectra:*
- **numberSpectra**: Total number of MS1 spectra
- **medianPrecursorMz**: Median m/z value of precursor ions
- **extentIdentifiedPrecursorIntensity**: Extent of identified precursor intensities

*MS2 Metrics (when enabled):*
- **numberMS2Spectra**: Total number of MS2 spectra
- **medianPrecursorIntensity**: Median intensity of precursor ions
- **medianNumberFragments**: Median number of fragment ions per spectrum

**Example Output**

The output is a tab-separated table where:
- The first column contains metric names
- Subsequent columns contain metric values for each input file
- Each row represents a different quality metric

Example for two samples::

    Metric                          sample1.mzML    sample2.mzML
    areaUnderTIC                   1.23e+09        1.45e+09
    chromatographyDuration         600.5           598.2
    numberSpectra                  1250            1180
    medianPrecursorMz              524.3           526.1
    ...

**Visualization**

The output table can be visualized using Galaxy's visualization tools such as:
- Scatterplot to compare metrics across samples
- Heatmap to visualize metric patterns
- Boxplot to show metric distributions

**References**

For more information about the MsQuality package and available metrics, see:
- MsQuality package: https://bioconductor.org/packages/release/bioc/html/MsQuality.html
- Tutorial: https://bioconductor.org/packages/release/bioc/vignettes/MsQuality/inst/doc/MsQuality.html
- mzQC framework: https://github.com/HUPO-PSI/mzQC
    ]]></help>
    
    <expand macro="citations"/>
</tool>
