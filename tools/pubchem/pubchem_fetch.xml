<tool id="pubchem_fetch" name="Pubchem Fetch" version="0.1">
    <macros>
        <token name="@PUBCHEM_MIRROR@">ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/</token>
    </macros>

    <requirements>
        <requirement type="package">tar</requirement>
        <requirement type="package">wget</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        bash $fetch > $pubchem_database
    ]]></command>

    <configfiles>
        <configfile name="fetch"><![CDATA[
            #from urllib.parse import unquote, urlparse, urljoin
            #from pathlib import PurePosixPath

            #set $cut_dirs = len(PurePosixPath(unquote(urlparse(str($mirror)).path)).parts) - 1

            #for $subset in $subsets
                wget --recursive --accept=ttl.gz --no-host-directories --cut-dirs=${cut_dirs} --directory-prefix=pubchem $urljoin(str($mirror), str($subset))
            #end for

            tar -cvf $pubchem_database pubchem
        ]]></configfile>
    </configfiles>

    <inputs>
        <param name="mirror" type="text" label="PubChemRDF Mirror" value="@PUBCHEM_MIRROR@">
            <option value="@PUBCHEM_MIRROR@">@PUBCHEM_MIRROR@</option>
        </param>
        <param name="subsets" type="select" display="checkboxes" multiple="true">
            <label>PubChemRDF Subsets</label>
            <help>Select particular PubChemRDF subsets to fetch. Omitting some subsets could substantially reduce the downloaded size.</help>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/compound/general">compound/general</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/compound/nbr2d">compound/nbr2d</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/compound/nbr3d">compound/nbr3d</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/descriptor/compound">descriptor/compound</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/descriptor/substance">descriptor/substance</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/substance">substance</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/synonym">synonym</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/inchikey">inchikey</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/bioassay">bioassay</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/measuregroup">measuregroup</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/endpoint">endpoint</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/protein">protein</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/pathway">pathway</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/conserveddomain">conserveddomain</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/gene">gene</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/source">source</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/concept">concept</option>
            <option value="ftp://ftp.ncbi.nlm.nih.gov/pubchem/RDF/reference">reference</option>
        </param>
    </inputs>

    <outputs>
        <data name="pubchem_database" format="tar"/>
    </outputs>

    <help><![CDATA[
        Download the PubChem_ database from an official mirror in the form of RDF_ files.

        Further, the RDF files may be loaded into an triplestore database an then queried using an SPARQL_ language.
        For more information please visit an official `PubChemRDF documentation`_.

        .. _RDF: https://www.w3.org/TR/rdf-primer/
        .. _SPARQL: https://www.w3.org/TR/rdf-sparql-query/
        .. _PubChem: https://pubchem.ncbi.nlm.nih.gov/
        .. _PubChemRDF documentation: https://pubchemdocs.ncbi.nlm.nih.gov/rdf
    ]]></help>
</tool>