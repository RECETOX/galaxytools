<tool id="xcms_plot_raw" name = "xcms plot raw" version="@TOOL_VERSION@+galaxy0" profile="21.09">
    <description>Plot raw data filtered by m/z range and retention time (RT) range</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="bio.tools"/>
    <expand macro="creator"/>
    <requirements>
        <requirement type="package" version="@TOOL_VERSION@">bioconductor-xcms</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        Rscript -e 'source("${plot_raw}")'
    ]]></command>
    <configfiles>
        <configfile name="plot_raw">
library(xcms)
library(MsExperiment)
library(Spectra)
mse = readMsExperiment(file.path('${input}'))
mz_offset = ${tolerance_ppm} * 1e-6 * ${mz_value}
rt_offset = ${rt_range} / 2
raw = mse |>
    filterRt(rt = ${rt} + c(-rt_offset, rt_offset)) |>
    filterMzRange(mz = ${mz_value} + c(-mz_offset, mz_offset))
png(filename = '${output_filename}')
par(oma = c(0.5, 2, 0.5, 1))
plot(raw)
dev.off()
        </configfile>
    </configfiles>
    <inputs>
        <param type="data" name="input" format="mzml" label="Input mzML file"/>
        <param type="float" name="mz_value" value="0.0" label="m/z Value" help="m/z value for the plot"/>
        <param type="integer" name="tolerance_ppm" value="10" label="Tolerance (ppm)" help="Tolerance for m/z value in ppm"/>
        <param type="float" name="rt" label="Retention Time" value="0.0" help="Retention time for the plot"/>
        <param type="float" name="rt_range" value="5.0" label="Retention Time Range" help="Retention time range for the plot"/>
    </inputs>
    <outputs>
        <data name="output_filename" format="png" label="PLot at m/z=$mz_value and rt=$rt of $input.element_identifier"/>
    </outputs>
    <tests>
        <test>
            <param name="input" value="xcms_plot_raw_testdata.mzML"/>
            <param name="mz_value" value="153.06583"/>
            <param name="tolerance_ppm" value="10.0"/>
            <param name="rt" value="171.922"/>
            <param name="rt_range" value="0.1"/>
            <output name="output_filename" file="raw_plot.png"/>
        </test>
    </tests>
<help><![CDATA[
    This tool plots the raw data filtered by m/z range and retention time (RT) range from an mzML file. 
    It uses a default tolerance of 10 ppm and retention time range of 5.
    ]]></help>
    <citations>
        <citation type="doi">10.1021/ac051437y</citation>
    </citations>
</tool>